<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Mini Project</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        h1, h2 { color: #2c3e50; }
        #auth-section, #chat-section {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        #chat-window {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fdfdfd;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .message { margin-bottom: 8px; line-height: 1.5; padding: 5px 10px; border-radius: 5px;}
        .user-message { text-align: right; color: #3498db; background-color: #eaf6ff; margin-left: 20%; }
        .ai-message { text-align: left; color: #27ae60; background-color: #e6ffee; margin-right: 20%; }
        .system-message { text-align: center; color: #888; font-size: 0.9em; margin: 10px 0; }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        button:hover:not(:disabled) { background-color: #2980b9; }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        input[type="text"], input[type="password"], input[type="email"] { /* input[type="email"] 추가 (필요시) */
            padding: 10px 12px;
            width: calc(100% - 24px);
            max-width: 300px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        textarea {
            width: calc(100% - 10px);
            height: 80px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            resize: vertical;
            margin-bottom: 10px;
        }
        .tab-button {
            background-color: #ecf0f1;
            color: #333;
            border: 1px solid #dcdcdc;
            border-bottom: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 1.1em;
            margin-right: 5px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #fff;
            border-color: #3498db;
            color: #3498db;
            font-weight: bold;
        }
        .form-section {
            display: none;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .form-section.active { display: block; }
        p[id$="Status"] { margin-top: 10px; font-weight: bold; }
        p[id$="Status"][style*="green"] { color: #28a745; }
        p[id$="Status"][style*="red"] { color: #dc3545; }
    </style>
</head>
<body>
    <h1>ChatGPT 미니 프로젝트</h1>

    <div id="auth-section">
        <button id="show-login" class="tab-button active">로그인</button>
        <button id="show-register" class="tab-button">회원가입</button>

        <div id="login-form" class="form-section active">
            <h2>로그인</h2>
            <input type="text" id="loginUsername" placeholder="사용자 이름">
            <input type="password" id="loginPassword" placeholder="비밀번호">
            <button id="loginButton">로그인</button>
            <p id="loginStatus" style="color: red;"></p>
        </div>

        <div id="register-form" class="form-section">
            <h2>회원가입</h2>
            <input type="text" id="registerUsername" placeholder="새 사용자 이름">
            <input type="password" id="registerPassword" placeholder="비밀번호">
            <input type="password" id="registerPasswordConfirm" placeholder="비밀번호 확인">
            <button id="registerButton">회원가입</button>
            <p id="registerStatus" style="color: red;"></p>
        </div>
    </div>

    <div id="chat-section" style="display: none;">
        <h2>채팅</h2>
        <p>환영합니다, <strong id="loggedInUser"></strong>님!</p>
        <div id="chat-window"></div>
        <input type="text" id="chatInput" placeholder="메시지를 입력하세요...">
        <button id="sendButton">전송</button>
        <button id="logoutButton">로그아웃</button>
        <p id="chatStatus" style="color: red;"></p>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let accessToken = null;
        let currentUsername = null; // 현재 로그인된 사용자 이름 저장

        // --- UI 요소 선택 ---
        const authSection = document.getElementById('auth-section');
        const chatSection = document.getElementById('chat-section');

        const showLoginButton = document.getElementById('show-login');
        const showRegisterButton = document.getElementById('show-register');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');

        const loginUsernameInput = document.getElementById('loginUsername');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const loginStatus = document.getElementById('loginStatus');

        const registerUsernameInput = document.getElementById('registerUsername');
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerPasswordConfirmInput = document.getElementById('registerPasswordConfirm');
        // const registerEmailInput = document.getElementById('registerEmail'); // HTML에서 제거되었으므로, JS에서도 제거
        const registerButton = document.getElementById('registerButton');
        const registerStatus = document.getElementById('registerStatus');

        const loggedInUser = document.getElementById('loggedInUser');
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const logoutButton = document.getElementById('logoutButton');
        const chatStatus = document.getElementById('chatStatus');

        // --- 탭 전환 기능 ---
        function showAuthForm(formId) {
            document.querySelectorAll('.form-section').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(formId).classList.add('active');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (formId === 'login-form') {
                showLoginButton.classList.add('active');
            } else {
                showRegisterButton.classList.add('active');
            }
            loginStatus.textContent = '';
            registerStatus.textContent = '';
        }

        // 탭 버튼 클릭 이벤트 리스너
        showLoginButton.addEventListener('click', () => showAuthForm('login-form'));
        showRegisterButton.addEventListener('click', () => showAuthForm('register-form'));


        // --- 메시지를 채팅창에 추가하는 함수 ---
        function addMessage(sender, message, type) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', type);
            msgDiv.textContent = `${sender}: ${message}`;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- 채팅 UI (입력 필드/버튼) 활성화/비활성화 함수 ---
        function setChatUIEnabled(enabled) {
            chatInput.disabled = !enabled;
            sendButton.disabled = !enabled;
            if (enabled) {
                sendButton.textContent = '전송';
                chatStatus.textContent = '';
            } else {
                sendButton.textContent = '전송 중...';
                chatStatus.textContent = 'AI 응답 대기 중...';
            }
        }

        // --- 로그인 처리 ---
        loginButton.addEventListener('click', async () => {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value;
            loginStatus.textContent = '';

            if (!username || !password) {
                loginStatus.textContent = '사용자 이름과 비밀번호를 입력해주세요.';
                return;
            }

            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await fetch(`${API_BASE_URL}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData.toString()
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '로그인 실패');
                }

                const data = await response.json();
                accessToken = data.access_token;
                currentUsername = username; // 로그인 성공 시 사용자 이름 저장
                localStorage.setItem('accessToken', accessToken);
                localStorage.setItem('username', currentUsername);

                loggedInUser.textContent = currentUsername;
                authSection.style.display = 'none';
                chatSection.style.display = 'block';
                addMessage('System', '로그인 성공! 채팅 기록을 불러오는 중...', 'system-message');
                await loadChatHistory(); // 로그인 성공 시 채팅 기록 불러오기

            } catch (error) {
                loginStatus.textContent = `로그인 오류: ${error.message}`;
                console.error('로그인 에러:', error);
            }
        });

        // --- 회원가입 처리 (registerEmailInput 제거 반영) ---
        registerButton.addEventListener('click', async () => {
            const username = registerUsernameInput.value.trim();
            const password = registerPasswordInput.value;
            const passwordConfirm = registerPasswordConfirmInput.value;
            // const email = registerEmailInput.value.trim(); // HTML에서 제거되었으므로, 이 줄도 제거
            registerStatus.textContent = '';

            if (!username || !password || !passwordConfirm) {
                registerStatus.textContent = '사용자 이름과 비밀번호를 입력해주세요.';
                return;
            }
            if (password !== passwordConfirm) {
                registerStatus.textContent = '비밀번호가 일치하지 않습니다.';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                        // email: email || null // HTML에서 제거되었으므로, 이 줄도 제거
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '회원가입 실패');
                }

                const data = await response.json();
                registerStatus.style.color = 'green';
                registerStatus.textContent = `회원가입 성공: ${data.username}님 환영합니다! 이제 로그인해주세요.`;
                registerUsernameInput.value = '';
                registerPasswordInput.value = '';
                registerPasswordConfirmInput.value = '';
                // registerEmailInput.value = ''; // HTML에서 제거되었으므로, 이 줄도 제거
                showAuthForm('login-form');

            } catch (error) {
                registerStatus.style.color = 'red';
                registerStatus.textContent = `회원가입 오류: ${error.message}`;
                console.error('회원가입 에러:', error);
            }
        });

        // --- 채팅 메시지 저장 함수 (이 함수는 이제 프론트엔드에서 직접 호출되지 않음. 백엔드에서만 사용) ---
        // 백엔드에서 메시지를 저장하므로, 프론트엔드에서 saveChatMessage를 직접 호출할 필요가 없습니다.
        // 이 함수 자체는 필요하지만, 프론트엔드 코드에서는 호출되지 않습니다.
        async function saveChatMessage(role, content) {
            if (!accessToken || !currentUsername) {
                console.warn("로그인되지 않아 채팅 메시지를 저장할 수 없습니다.");
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/chat/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        username: currentUsername,
                        role: role,
                        content: content,
                        timestamp: new Date().toISOString()
                    })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('채팅 기록 저장 실패:', errorData.detail || '알 수 없는 오류');
                }
            } catch (error) {
                console.error('채팅 기록 저장 중 네트워크 오류:', error);
            }
        }


        // --- 채팅 기록 불러오기 함수 (기존 로직 유지) ---
        async function loadChatHistory() {
            chatWindow.innerHTML = ''; // 기존 채팅창 비우기
            if (!accessToken || !currentUsername) {
                addMessage('System', '채팅 기록을 불러올 수 없습니다. 로그인해주세요.', 'system-message');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/chat/history`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('인증 실패. 다시 로그인해주세요.');
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '채팅 기록 불러오기 실패');
                }

                const data = await response.json();
                if (data.history && data.history.length > 0) {
                    addMessage('System', '이전 채팅 기록을 불러왔습니다.', 'system-message');
                    data.history.forEach(msg => {
                        const sender = msg.role === 'user' ? 'You' : 'AI';
                        const type = msg.role === 'user' ? 'user-message' : 'ai-message';
                        addMessage(sender, msg.content, type);
                    });
                } else {
                    addMessage('System', '이전 채팅 기록이 없습니다. 새로운 대화를 시작하세요!', 'system-message');
                }

            } catch (error) {
                chatStatus.textContent = `채팅 기록 불러오기 오류: ${error.message}`;
                console.error('채팅 기록 불러오기 에러:', error);
                if (error.message.includes('인증 실패')) {
                    handleLogout();
                }
            }
        }

        // --- 채팅 메시지 전송 (저장 로직은 백엔드에서만 처리) ---
        sendButton.addEventListener('click', async () => {
            const message = chatInput.value.trim();
            if (!message) return;

            addMessage('You', message, 'user-message'); // 사용자 메시지는 즉시 UI에 표시
            chatInput.value = '';

            setChatUIEnabled(false); // 전송 중 UI 비활성화

            try {
                const response = await fetch(`${API_BASE_URL}/chat/simple`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('인증 실패. 다시 로그인해주세요.');
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '채팅 응답 실패');
                }

                const data = await response.json();
                const aiResponseContent = data.response;

                addMessage('AI', aiResponseContent, 'ai-message'); // AI 응답 메시지는 UI에 표시

            } catch (error) {
                chatStatus.textContent = `채팅 오류: ${error.message}`;
                console.error('채팅 에러:', error);
                if (error.message.includes('인증 실패')) {
                    handleLogout();
                }
            } finally {
                setChatUIEnabled(true); // 요청 완료 후 UI 활성화
            }
        });

        // --- 로그아웃 처리 ---
        logoutButton.addEventListener('click', handleLogout);

        function handleLogout() {
            accessToken = null;
            currentUsername = null; // 사용자 이름도 초기화
            localStorage.removeItem('accessToken');
            localStorage.removeItem('username');
            authSection.style.display = 'block';
            chatSection.style.display = 'none';
            chatWindow.innerHTML = '';
            loginUsernameInput.value = '';
            loginPasswordInput.value = '';
            registerUsernameInput.value = '';
            registerPasswordInput.value = '';
            registerPasswordConfirmInput.value = '';
            // registerEmailInput.value = ''; // HTML에서 제거되었으므로, 이 줄도 제거
            loginStatus.textContent = '로그아웃 되었습니다.';
            chatStatus.textContent = '';
            showAuthForm('login-form');
        }

        // --- 페이지 로드 시 초기화 및 자동 로그인 시도 ---
        window.onload = async () => { // async 키워드 추가
            const storedToken = localStorage.getItem('accessToken');
            const storedUsername = localStorage.getItem('username');
            if (storedToken && storedUsername) {
                accessToken = storedToken;
                currentUsername = storedUsername; // 로컬 스토리지에서 사용자 이름 로드
                loggedInUser.textContent = currentUsername;
                authSection.style.display = 'none';
                chatSection.style.display = 'block';
                // 로그인 후 채팅 기록을 바로 불러옵니다.
                await loadChatHistory();
            } else {
                showAuthForm('login-form');
            }
        };

    </script>
</body>
</html>