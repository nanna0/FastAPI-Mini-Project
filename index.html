<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Mini Project</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #login-section, #chat-section { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; }
        #chat-window { height: 300px; overflow-y: scroll; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; }
        .message { margin-bottom: 5px; }
        .user-message { text-align: right; color: blue; }
        .ai-message { text-align: left; color: green; }
        button { margin-top: 10px; padding: 8px 15px; cursor: pointer; }
        input[type="text"], input[type="password"] { padding: 8px; width: 200px; margin-right: 5px; }
        textarea { width: 98%; height: 60px; padding: 5px; }
    </style>
</head>
<body>
    <h1>ChatGPT 미니 프로젝트</h1>

    <div id="login-section">
        <h2>로그인</h2>
        <input type="text" id="username" placeholder="사용자 이름 (예: testuser)">
        <input type="password" id="password" placeholder="비밀번호 (예: testpassword)">
        <button id="login-button">로그인</button>
        <p id="login-status" style="color: red;"></p>
    </div>

    <div id="chat-section" style="display: none;">
        <h2>채팅</h2>
        <p>환영합니다, <strong id="loggedInUser"></strong>님!</p>
        <div id="chat-window"></div>
        <input type="text" id="chat-input" placeholder="메시지를 입력하세요...">
        <button id="send-button">전송</button>
        <button id="logout-button">로그아웃</button>
        <p id="chat-status" style="color: red;"></p>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let accessToken = null;

        const loginSection = document.getElementById('login-section');
        const chatSection = document.getElementById('chat-section');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const loginStatus = document.getElementById('login-status');
        const loggedInUser = document.getElementById('loggedInUser');

        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const logoutButton = document.getElementById('logout-button');
        const chatStatus = document.getElementById('chat-status');


    // 입력 필드와 버튼의 활성화/비활성화 상태를 관리하는 함수
        function setChatUIEnabled(enabled) {
            chatInput.disabled = !enabled; // enabled가 true면 disabled=false (활성화), false면 disabled=true (비활성화)
            sendButton.disabled = !enabled;
            if (enabled) {
                sendButton.textContent = '전송'; // 버튼 텍스트 복원
                chatStatus.textContent = ''; // 상태 메시지 지우기
            } else {
                sendButton.textContent = '전송 중...'; // 버튼 텍스트 변경
                chatStatus.textContent = 'AI 응답 대기 중...'; // 상태 메시지 설정
            }
        }

        // 메시지를 채팅창에 추가하는 함수
        function addMessage(sender, message, type) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', type);
            msgDiv.textContent = `${sender}: ${message}`;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // 스크롤 하단으로 이동
        }

        // 로그인 처리
        loginButton.addEventListener('click', async () => {
            const username = usernameInput.value;
            const password = passwordInput.value;
            loginStatus.textContent = '';

            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await fetch(`${API_BASE_URL}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded' // OAuth2PasswordRequestForm 형식
                    },
                    body: formData.toString()
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '로그인 실패');
                }

                const data = await response.json();
                accessToken = data.access_token;
                localStorage.setItem('accessToken', accessToken); // 로컬 스토리지에 토큰 저장 (새로고침 시 유지)
                localStorage.setItem('username', username);

                loggedInUser.textContent = username;
                loginSection.style.display = 'none';
                chatSection.style.display = 'block';
                loginStatus.textContent = '';
                addMessage('System', '로그인 성공! 채팅을 시작하세요.', 'system-message');

            } catch (error) {
                loginStatus.textContent = `로그인 오류: ${error.message}`;
                console.error('로그인 에러:', error);
            }
        });

        // 채팅 메시지 전송
        sendButton.addEventListener('click', async () => {
            const message = chatInput.value.trim();
            if (!message) return;

            addMessage('You', message, 'user-message');
            chatInput.value = ''; // 메세지 추가 후 입력 필드 먼저 비움
            setChatUIEnabled(false); // UI 비활성화
            chatStatus.textContent = 'AI 응답 대기 중...';

            try {
                const response = await fetch(`${API_BASE_URL}/chat/simple`, { // 또는 chat/conversation
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}` // JWT 토큰 포함
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('인증 실패. 다시 로그인해주세요.');
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '채팅 응답 실패');
                }

                const data = await response.json();
                addMessage('AI', data.response, 'ai-message');
                //chatStatus.textContent = '';

            } catch (error) {
                chatStatus.textContent = `채팅 오류: ${error.message}`;
                console.error('채팅 에러:', error);
                if (error.message.includes('인증 실패')) {
                    handleLogout(); // 인증 실패 시 로그아웃 처리
                }
            } finally {
              setChatUIEnabled(true); // API 요청 성공/실패와 관계 없이 항상 UI 활성화
            }
        });

        // 로그아웃 처리
        logoutButton.addEventListener('click', handleLogout);

        function handleLogout() {
            accessToken = null;
            localStorage.removeItem('accessToken');
            localStorage.removeItem('username');
            loginSection.style.display = 'block';
            chatSection.style.display = 'none';
            chatWindow.innerHTML = ''; // 채팅창 비우기
            usernameInput.value = '';
            passwordInput.value = '';
            loginStatus.textContent = '로그아웃 되었습니다.';
            chatStatus.textContent = '';
        }

        // 페이지 로드 시 로컬 스토리지에서 토큰 확인하여 자동 로그인 시도
        window.onload = () => {
            const storedToken = localStorage.getItem('accessToken');
            const storedUsername = localStorage.getItem('username');
            if (storedToken && storedUsername) {
                accessToken = storedToken;
                loggedInUser.textContent = storedUsername;
                loginSection.style.display = 'none';
                chatSection.style.display = 'block';
                addMessage('System', '이전 세션으로 로그인되었습니다. 채팅을 시작하세요.', 'system-message');
            }
        };

    </script>
</body>
</html>
